% !TeX root = ../QFT_main.tex
%=========================================================
%=========================================================
\chapter{Canonical Quantization}
%========================================================
%=========================================================


%--------------------------------------------------------
%=========================================================
\section{Canonical Quantization in flat spacetime}
%=========================================================
%------------------------------------------------------------



\begin{mytheorem}[Towards the Klein-Gordon Lagrangian\todotag{Finish}]
%
Consider the Lagrangian for a discrete set of classical harmonic oscillator in $d$ dimensions with some potential $V(q_n)$,
\begin{align}
    \mathcal{L}= \sum_{n\in \Z^d}\frac{1}{2} \mu \dot{q}_n^2 - \frac{1}{2} \mu \omega_n^2 \sum_{j=1}^d (q_n - q_{n +\hat{e}_j})^2 - V(q_n).
\end{align}
The density of oscillators is $\rho = \mu / a^d$ and the speed of sound is $c_s = a \omega_n$, where $a$ is the lattice spacing, are kept constant as we take the continuum limit $a \to 0$.
The Lagrangian then becomes
\begin{align}
    \mathcal{L} &= \sum_{n\in \Z^d} a^d \left[ \frac{1}{2} \rho \dot{q}_n^2 - \frac{1}{2} \rho (a\omega_n)^2 \sum_{j=1}^d \left(\frac{q_n - q_{n +\hat{e}_j}}{a}\right)^2 - \frac{1}{a^d} V(q_n) \right]
    \\
    & 
    \sum_{n\in \Z^d} a^d \left[ \frac{1}{2} \big(\rho^{1/2} \dot{q}_n\big)^2 - \frac{1}{2} (a\omega_n)^2 \sum_{j=1}^d \left(\frac{\rho^{1/2}q_n - \rho^{1/2}q_{n +\hat{e}_j}}{a}\right)^2 - \frac{1}{a^d} V(\rho^{-1/2}\rho^{1/2}q_n) \right]
    \\
    &\xrightarrow[a\to 0]{} \int d^d\!x\,\,\, \tfrac{1}{2} \left(\partial_t\phi(t,\mathbf{x})\right)^2 - \tfrac{1}{2} c_s^2 \,\left(\nabla_x\phi(t,\mathbf{x})\right)^2 - \mathcal{V}(\phi(t,\mathbf{x})),
\end{align}
where we redefined the field as $\phi(t,\mathbf{x}) := \rho^{1/2} q_n(t)= \mu^{1/2}a^{-d/2} q_n(t)$ and the potential density as $\mathcal{V}(\phi) := \lim_{a\to 0} a^{-d} V(\rho^{-1/2} \phi)$.
Choosing a quadratic potential $V(q_n) = \tfrac{1}{2} \mu^2 q_n^2$ yields the Klein-Gordon lagrangian density for a free scalar field of mass $\mu$.


Note that we absorbed a factor $\mu^{1/2}$ in the rescaling of the field.
Therefore in d+1 spacetime the field $\phi(t,\mathbf{x}) := \rho^{1/2} q_n(t)= \mu^{1/2}a^{-d/2} q_n(t)$ has energy dimension $[\phi] = E^{-1/2} E^{d/2} = E^{(d-1)/2}$, and its Fourier transform $\phi_k= \int d^dx \phi_x e^{ixk}$ has dimension $[\phi_k] = E^{-1/2} E^{-d/2}$.
Below we will identify harmonic oscillator variables constituting the field as $\phi_k\sim q_k+\tfrac{1}{\omega_k} p_k$, so that $[q_k] = E^{-1/2} E^{-d/2}$ and $[p_k] = E^{1/2} E^{-d/2}$.
Since the mass $\mu$ has already been absorbed, \emph{adimensional} density\footnote{In the sense they are 'square-root densities' in $k$-space i.e. $[\tilde{q}_k]=[\tilde{p}_k]=E^{-d/2}$} variables will then be obtained rescaling as
\begin{equation}
    \tilde{q}_k = \sqrt{\frac{\omega_k}{\hbar}} q_k, \quad \tilde{p}_k = \frac{1}{\hbar}\sqrt{\frac{\hbar}{\omega_k}} p_k,\quad
    \text{instead of the usual}\quad \tilde{q}_k = \sqrt{\frac{m\omega_k}{\hbar}} q_k,\quad \tilde{p}_k = \frac{1}{\hbar}\sqrt{\frac{\hbar}{m\omega_k}} p_k.
\end{equation}
%
\end{mytheorem}


\begin{mytheorem}[Review of classical \& quantum harmonic oscillator\todotag{Finish}]
%
The \emph{classical} harmonic oscillator with mass $m$ and frequency $\omega$ is described by the Hamiltonian
\begin{equation}
    H = \tfrac{1}{2m}p^2 + \tfrac{m\omega^2}{2} q^2, \quad \{q, p\} = \delta_{ij}\,,
\end{equation}
where $q$ and $p$ are the canconical conjugate variables, obeying the Poisson brackets.
%
Rewrite the conjugate variables in terms of adimensional ones to match the two prefactors as
\begin{align}
    \tilde{q}=\ell q, \quad \tilde{p}= \frac{\hbar}{\ell} p, \quad \{\tilde{q}, \tilde{p}\} = \hbar \delta_{ij},
     \quad \text{for}\quad \ell= \sqrt{\tfrac{\hbar}{m\omega}}.
\end{align}
The Hamiltonian becomes
\begin{align}
    H &= \hbar \omega \tfrac{1}{2}\left( {\tilde{p}}^2 + {\tilde{q}}^2 \right)
    \\
    &\overset{!}{=}\hbar \omega \left[
        \tfrac{1}{\sqrt{2}}\left( \tilde{p} - i \tilde{q} \right)
        \cdot \tfrac{1}{\sqrt{2}}\left( \tilde{p} + i \tilde{q} \right)
    \right],
\end{align}
where in the second passage we used that $\tilde{p}$ and $\tilde{q}$ commute in the \emph{classical} theory.
%
Following Heisenberg canonical quantization procedure, promote the classical theory to a quantum one as follows.
\begin{itemize}
    \item Promote the canonical variables to operators acting on a Hilbert space $\mathcal{F}$.
    %
    \item Poisson brackets are replaced by commutators according to the rule $\displaystyle \{A, B\} \mapsto \frac{1}{i\hbar} [\hat{A}, \hat{B}]$.
    %
    \item The equations of motion are left formally unchanged, but now refer to evolving operators.
\end{itemize}
%
The Hamiltonian operator is given by
\begin{equation}
    \hat{H} = \tfrac{1}{2m}{p}^2 + \tfrac{m\omega^2}{2} {q}^2= \tfrac{1}{2}\hbar \omega \left( {\tilde{p}}^2 + {\tilde{q}}^2 \right).
\end{equation}
The Poisson brackets turn into the canonical commutation relations
\begin{align}
    [q,p]=i\hbar \delta_{ij} ,
    \qquad
    [\tilde{q}, \tilde{p}] = i \delta_{ij}.
\end{align}
We cannot use the previous factorization since now $\tilde{p}$ and $\tilde{q}$ do not commute anymore.
We have instead
\begin{align}
    \hat{H} &=     
    \hbar \omega \bigg[
        \underbrace{\tfrac{1}{\sqrt{2}}\left( \tilde{p} - i \tilde{q} \right)}_{a}
        \cdot
        \underbrace{\tfrac{1}{\sqrt{2}}\left( \tilde{p} + i \tilde{q} \right)}_{a^{\dagger}}
        + \underbrace{\tfrac{1}{2}[\tilde{p}, i\tilde{q}]}_{=\frac{1}{2} i \hbar}
    \Big] = \tfrac{1}{2}\hbar\omega \left(a^\dagger a+ a a^\dagger\right)
    = \hbar \omega \left( a^{\dagger} a + \tfrac{1}{2} \right),
\end{align}
for the creation and annihilation operators
{
\begin{align}\label{eq:ordinary_QM_harmonic_oscillator}
    a^\dagger &= \tfrac{1}{\sqrt{2}}\left( \tilde{p} - i \tilde{q} \right) = \tfrac{1}{\sqrt{2\hbar}} \left(\sqrt{m\omega} \,q - \tfrac{i}{\sqrt{m\omega}} p \right), \,\,
    a = \tfrac{1}{\sqrt{2}}\left( \tilde{p} + i \tilde{q} \right) = \tfrac{1}{\sqrt{2\hbar}} \left( \sqrt{m\omega}\, q + \tfrac{i}{\sqrt{m\omega}} p \right),\,\, [a, a^\dagger] = 1.
\end{align}
}
%
The energy eigenvalues of the quantum harmonic oscillator are
\begin{equation}
    E_n = \hbar \omega \left( n + \tfrac{1}{2} \right), \quad n = 0, 1, 2, \ldots
\end{equation}
%
In the familiar position representation  we have
\begin{align}
    q &= x, \quad p = -i \hbar \partial_x, \qquad 
    \tilde{q}=\xi := \frac{x}{\ell}=\sqrt{\tfrac{m\omega}{\hbar}} x, \quad \tilde{p} = -i \frac{d}{d\xi},\\
    a^\dagger &= \tfrac{1}{\sqrt{2}}\left(\xi-\partial_\xi\right) = \tfrac{1}{\sqrt{2}}\left(\sqrt{\tfrac{m\omega}{\hbar}} x - \sqrt{\tfrac{\hbar}{m\omega}} \partial_x\right), \quad
    \quad a = \tfrac{1}{\sqrt{2}}\left(\xi+\partial_\xi\right)= \tfrac{1}{\sqrt{2}}\left(\sqrt{\tfrac{m\omega}{\hbar}} x + \sqrt{\tfrac{\hbar}{m\omega}} \partial_x\right).
\end{align}

We remark that we could have equivalently started the quantization procedure directly from the last expression of the \emph{classical} Hamiltonian
\begin{align}
    H&\overset{!}{=}\hbar \omega \left[\tfrac{1}{\sqrt{2}}\left( \tilde{p} - i \tilde{q} \right)
        \cdot \tfrac{1}{\sqrt{2}}\left( \tilde{p} + i \tilde{q} \right)\right] = \hbar \omega \left( a^\dagger a \right).
\end{align}
This corresponds to normal-ordering of the previous \emph{quantum} Hamiltonian, removing the zero-point energy $\hbar \omega/2$.
As long as gravity is ignored, constant energy shifts do not affect the dynamics of the system, and we can safely normal-order the Hamiltonian.
In general relativity, all forms of energy will instead source the energy-momentum tensors and thus the gravitational field, and we cannot simply ignore the zero-point energy anymore.

It is fundamental to understand how the \emph{fixed} frequency $\omega$ of the oscillator determines the likelyhood of finding the system at a given elongation from equilibrium i.e. the amplitude of oscillation.
Indeed, all wave functions are proportional to a Gaussian factor, multiplied by suitable Hermite polynomials and normalization constants
\begin{align}
    \psi_n(q) = C_n\,H_n(\xi)\, e^{-\tfrac{\xi^2}{2}} = C_n \,\, H_n\Big(\sqrt{\tfrac{m\omega}{\hbar}} q\Big) \,\, e^{-\frac{m \omega}{2 \hbar} q^2}
     \,\propto\, e^{-\frac{m \omega}{2 \hbar} q^2}.
\end{align}
Crucially, the smaller is the frequency $\omega$, the wider is the Gaussian and in turn the higher the probability of finding the oscillator at large elongations from equilibrium i.e. of observing large amplitudes of oscillation.
This is already familiar from Electrodynamics: it is very unlikely to find high-frequency electromagnetic waves with large amplitudes, whereas low-frequency waves are easily found with large amplitudes.
%
\end{mytheorem}


\begin{mytheorem}[Free Klein-Gordon field as waves on a lake \& Fourier modes as decoupled harmonic oscillators]
\todotag{Finish \& insert image of lake \& fourier modes (cf. kempf)}
The classical (free) Klein-Gordon field is completely analogous to the surface of a lake.
It should be seen as a collection of \emph{coupled} harmonic oscillators, one at each point of space, or equivalently of \emph{decoupled} harmonic oscillators in momentum space i.e. independent Fourier modes, each oscillating with its own frequency.
Both for the field and the lake surface, a perturbation in space will spread and deform overtime, propagating as a superposition of waves with various frequencies and exciting neighbouring points.
On the other hand, a wave with fixed frequency will oscillate but maintain its shape (amplitude and frequency) over time, freely travelling across the lake surface without deforming.

In the absence of excitations, say `no rocks thrown into the lake', the surface of the lake (i.e. the classical field) will stay flat or retain its initial excitation, if any.
In the quantum case, there will be fluctuations on top of these classical profiles due to zero-point energy of each Fourier mode, even in the absence of external perturbations.

In order to probe the lake profile at a given point, we can use a cork floating on the water surface.
The analogous procedure for the field would be to use an atom or another suitable (quantum) system that can be acted upon by the field, both in the classical and quantum case.
We discuss this in more detail below.
\end{mytheorem}

\begin{mytheorem}[Probing the Klein-Gordon field with a cork] \todotag{write}
\todotag{Insert image}
How would you probe the waves on a lake? A good idea is to use a cork floating on the water surface.
The cork moves up and down following the local height of the water surface, thus providing a direct measurement of the wave amplitude at that point.
Analogously, to probe the Klein-Gordon field, we can use a point-like detector that measures the field value at a specific spacetime point.
This detector interacts with the field, allowing us to extract information about the field's behavior and dynamics.
The cork would now be an atom or another suitable quantum system that can be acted upon by the field.
\end{mytheorem}



\begin{mytheorem}[Classical theory of the Klein-Gordon field]
%
A real free scalar field $\phi(x)$ obeys the Klein-Gordon equation, 
\begin{equation}
    (\partial_{\mu} \partial^{\mu} + m^2) \phi(x) = 0.
\end{equation}
This is a wave equation with relativistic dispersion relation $E^2 = |\mathbf{p}|^2 + m^2$ for the field excitations.
It is the Euler-Lagrange equation of the nonunique Lagrangian (density) and action
\begin{equation}
    \mathcal{L} = \frac{1}{2} \partial_{\mu} \phi \partial^{\mu} \phi - \frac{1}{2} m^2 \phi^2, 
    \quad L=\int d^3 x\, \mathcal{L},\quad S = \int dx^0 L = \int d^4 x\, \mathcal{L}.
\end{equation}
The corresponding conjugate momentum and Hamiltonian density are 
\begin{equation}
    \pi(x) = \frac{\delta L}{\delta \partial_0 \phi(x)} = \frac{\partial \mathcal{L}}{\partial\big(\partial_0 \phi(x)\big)} = \partial_0 \phi(x), 
    \qquad 
    \mathcal{H} = \frac{1}{2} \pi^2 + \frac{1}{2} (\nabla \phi)^2 + \frac{1}{2} m^2 \phi^2.
\end{equation}
In the classical theory, the fields $\phi(x)$ and $\pi(x)$ satisfy the equal-time Poisson brackets 
\begin{align}
    \{\phi(t, \mathbf{x}), \pi(t, \mathbf{y})\} = \delta^{(3)}(\mathbf{x} - \mathbf{y}), \quad
    \{\phi(t, \mathbf{x}), \phi(t, \mathbf{y})\} = 0, \quad
    \{\pi(t, \mathbf{x}), \pi(t, \mathbf{y})\} = 0.
\end{align}
More generally, the equation of motions for any functional $\mathcal{O}[\phi, \pi]$ of the fields is given by the Poisson brackets
\begin{equation}
    \frac{d\mathcal{O}}{dt} = \{\mathcal{O}, H\} + \frac{\partial \mathcal{O}}{\partial t},
    \quad \text{for}\quad
    \{\mathcal{O}_1,\mathcal{O}_2\} = \int d^3 x\, \left( \frac{\delta \mathcal{O}_1}{\delta \phi(x)} \frac{\delta \mathcal{O}_2}{\delta \pi(x)} - \frac{\delta \mathcal{O}_1}{\delta \pi(x)} \frac{\delta \mathcal{O}_2}{\delta \phi(x)} \right),
\end{equation}
where the Hamiltonian is $H = \int d^3 x\, \mathcal{H}$. 
In particular, the fundamental fields obey the equations of motion, which equivalently combine into the Klein-Gordon equation,
\begin{align}
    \frac{d\phi(t, \mathbf{x})}{dt} = \{\phi(t, \mathbf{x}), H\} = \pi(t, \mathbf{x}), \quad
    \frac{d\pi(t, \mathbf{x})}{dt} = \{\pi(t, \mathbf{x}), H\} = (\nabla^2 - m^2) \phi(t, \mathbf{x}). 
\end{align}
%
\end{mytheorem}


\begin{mytheorem}[Canonical quantization of the Klein-Gordon field]
%
Following Heisenberg canonical quantization procedure, we promote the classical theory to a quantum theory as follows.
\begin{itemize}
    \item Promote the classical fields $\phi(x)$ and $\pi(x)$ to operators $\hat{\phi}(x)$ and $\hat{\pi}(x)$ acting on a Hilbert space $\mathcal{F}$.
    %
    \item Poisson brackets are replaced by commutators according to the rule $\displaystyle \{A, B\} \mapsto \frac{1}{i\hbar} [\hat{A}, \hat{B}].$
    %
    \item The equations of motion are left formally unchanged, but now refer to evolving operators.
\end{itemize}
%
The equal-time Poisson backe of the field become the equal-time caonical commutation relations 
\begin{align}
    [\hat{\phi}(t, \mathbf{x}), \hat{\pi}(t, \mathbf{y})] &= i\hbar\, \delta^{(3)}(\mathbf{x} - \mathbf{y}), \quad
    [\hat{\phi}(t, \mathbf{x}), \hat{\phi}(t, \mathbf{y})] = 0, \quad
    [\hat{\pi}(t, \mathbf{x}), \hat{\pi}(t, \mathbf{y})] = 0.
\end{align}
%
The evolution of any operator $\mathcal{O}[\hat{\phi},\hat{\pi}]$ function of the fundamental fields is
\begin{equation}
    \frac{d\hat{\mathcal{O}}}{dt} = \frac{1}{i \hbar} [\hat{\mathcal{O}}, \hat{H}] + \frac{\partial \hat{\mathcal{O}}}{\partial t}, \quad \text{for}\quad
    \hat{H} = \int d^3x\,\, \hat{\mathcal{H}} = \int d^3 x\, \left( \frac{1}{2} \hat{\pi}^2 + \frac{1}{2} (\nabla \hat{\phi})^2 + \frac{1}{2} m^2 \hat{\phi}^2 \right).
\end{equation}
%
In particular, the fundamental fields obey the Heisenberg equations of motion
\begin{align}
    \begin{cases}\displaystyle
    \frac{d\hat{\phi}(t, \mathbf{x})}{dt} = \tfrac{1}{i \hbar} [\hat{\phi}(t, \mathbf{x}), \hat{H}] = \hat{\pi}(t, \mathbf{x}), \\[7pt]
    \displaystyle
    \frac{d\hat{\pi}(t, \mathbf{x})}{dt} = \tfrac{1}{i \hbar} [\hat{\pi}(t, \mathbf{x}), \hat{H}] = (\nabla^2 - m^2) \hat{\phi}(t, \mathbf{x}),
    \end{cases}
    \,\Longrightarrow\quad  (\partial_{\mu} \partial^{\mu} + m^2) \hat{\phi}(x) = 0.
\end{align}
which together again imply the field operator $\hat{\phi}(x)$ satisfies the Klein-Gordon equation.
%
\end{mytheorem}


\begin{mytheorem}[Fourier transform \& identifying the uncoupled DoFs of the Klein-Gordon field]
%  
The Fourier transform of the fields are defined as
\begin{equation}
    \phi_k(t) :=\int d^3 x\, e^{-i \mathbf{k} \cdot \mathbf{x}} \phi(t, \mathbf{x}), \qquad \pi_k(t) := \int d^3 x\, e^{-i \mathbf{k} \cdot \mathbf{x}} \pi(t, \mathbf{x}) = \frac{d }{dt}\phi_k(t).
\end{equation}
Note that self-adjointness in position space implies $\phi_k^{\dagger}(t) = \phi_{-k}(t), \,\pi_k^{\dagger}(t) = \pi_{-k}(t)$ in momentum space.
%
The Klein-Gordon equation simply becomes the equation for uncoupled harmonic oscillators
\begin{equation}
    \frac{d^2 }{dt^2}\phi_k(t) + (|\mathbf{k}|^2 + m^2) \phi_k(t) = 0, \quad \text{with frequency}\quad \omega_k = \sqrt{|\mathbf{k}|^2 + m^2}.
\end{equation}
Coherently, the Hamiltonian is just a sum of independent harmonic oscillator Hamiltonians
\begin{equation}
    H  = \int d^3x\,\left(\tfrac{1}{2} \pi^2 + \tfrac{1}{2} (\nabla \phi)^2 + \tfrac{1}{2} m^2 \phi^2\right) = \int \frac{d^3 k}{(2\pi)^3} \left( \tfrac{1}{2} \pi_k^\dagger\pi_k + \tfrac{1}{2} (|\mathbf{k}|^2 + m^2) \phi_k^\dagger \phi_{k} \right).
\end{equation}
Finally, the equal time commutation relations in momentum space become
\begin{align}
    [\hat{\phi}_k(t), \hat{\pi}_{k'}(t)] = i\hbar\, (2\pi)^3 \delta^{(3)}(\mathbf{k} + \mathbf{k}'), \quad
    [\hat{\phi}_k(t), \hat{\phi}_{k'}(t)] = 0, \quad
    [\hat{\pi}_k(t), \hat{\pi}_{k'}(t)] = 0.
\end{align}

It seems we managed to diagonalize the Hamiltonian and identify its uncoupled degrees of freedom of the theory, behaving as independent harmonic oscillators labelled by the momentum $\mathbf{k}$.
However something is off track.
\begin{itemize}
    \item The field $\phi_k$ is no more self-adjoint, since $\phi_k^{\dagger} = \phi_{-k}$, whereas we would rather our DoFs be observables.
    \item The delta functions of the CCR is $\delta^{(3)}(\mathbf{k} + \mathbf{k}')$ instead of the expected $\delta^{(3)}(\mathbf{k} - \mathbf{k}')$, suggesting that the conjugate momentum of the mode $\phi_k$ is actually $\pi_{-k}$ instead of $\pi_k$.
    \item We have a continuum of Fourier modes $k$, and Dirac $\delta$ instead of Kronecker $\delta$ for the DoFs.
\end{itemize}
These problems are all related.
The last one was expected, since we are considering infinite volume and thus a continuum of modes $k$.
Infrared regularization, like placing the theory in a finite box or ball, would immediately restore countable \emph{discrete} Fourier modes and Kronecker deltas.
In fact, considering a \emph{finite} box with Dirichlet or Neumann boundary conditions instead of periodic ones, would yield a Fourier expansion in \emph{real} sine and cosine modes, thereby solving also the first issue:
\begin{align}
    \hat{\phi}^{\mathrm{DBC}}_k(t) \simeq  \int_{\text{box}} \!\!d^3 x\, \sin(\mathbf{k} \mathbf{x}) \hat{\phi}(t, \mathbf{x})\,\in\R\,, \quad
    \hat{\phi}^{\mathrm{NBC}}_k(t) \simeq \int_{\text{box}} \!\!d^3 x\, \cos(\mathbf{k} \mathbf{x}) \hat{\phi}(t, \mathbf{x})\,\in\R.
\end{align}

In any case, the first two issues have more physical relevance and are still related.
We can fix them by explicitly rewriting $\phi_k$ as linear combination of \emph{physical} self-adjoint harmonic oscillators $\{q_k,p_k\}_k$ to highlight the true DoFs of the theory.
Alternatively, we can directly write $\phi_k$ in terms of creation and annihilation operators $a_k$, and then in turn identify the corresponding self-adjoint oscillators.
The two approaches are completely equivalent and force us to understand what to consider as \emph{the vacuum} of the theory.
%
\end{mytheorem}



\begin{mytheorem}[Observable DoFs of the Klein-Gordon field in flat spacetime.]
%
For a free theory in flat spacetime, we naively decompose the field operators at an arbitrary reference \emph{fixed} time $t_0$ in terms of creation and annihilation operators as
\begin{align}
    \hat{\phi}(x,t_0) &= \int \frac{d^3\bar{k}}{(2\pi)^3}\, e^{i\bar{k}\cdot\bar{x}} \hat{\phi}_k(t_0)
    =: \int \frac{d^3\bar{k}}{(2\pi)^3} \frac{1}{\sqrt{2\omega_k}} \left( a_k e^{i \bar{k}\cdot\bar{x}} + a_k^{\dagger} e^{- i \bar{k}\cdot\bar{x}} \right),
    \\
    \hat{\pi}(x,t_0) &= \int \frac{d^3\bar{k}}{(2\pi)^3}\, e^{i\bar{k}\cdot\bar{x}} \hat{\pi}_k(t_0)
    = : \int \frac{d^3\bar{k}}{(2\pi)^3} \frac{1}{\sqrt{2\omega_k}} \left( -i \omega_k a_k e^{i \bar{k}\cdot\bar{x}} + i \omega_k a_k^{\dagger} e^{- i \bar{k}\cdot\bar{x}} \right).
\end{align}
In terms of creation and annihilation operators the canonical commutation relations become\footnote{In order to get \emph{relativistically normalized} commutation relations $\propto 2E_k\delta^{(3)}(k-k')$, we should use covariant creation/annihilation operators $\sqrt{2\omega_k} a_k$ and $\sqrt{2\omega_k} a_k^\dagger$, that indeed correspond to relativistically normalized states in Minkowski spacetime.}
\begin{align}
    [a_{\bar{k}}, a_{\bar{k}'}^{\dagger}] = (2\pi)^3 \delta^{(3)}(\bar{k} - \bar{k}'),\quad
    [a_{\bar{k}}, a_{\bar{k}'}] = 0, \quad
    [a_{\bar{k}}^{\dagger}, a_{\bar{k}'}^{\dagger}] = 0.
\end{align}
%
The associated Hamiltonian, before normal ordering and using the CCR, reads
\begin{equation}
    \hat{H} =  \int \frac{d^3 k}{(2\pi)^3} \, \tfrac{1}{2}\hbar \omega_k \Big( a_k^{\dagger} a_k + a_k a_k^{\dagger} \Big)
    =\int \frac{d^3 k}{(2\pi)^3} \, \hbar \omega_k \Big( a_k^{\dagger} a_k + \tfrac{1}{2} (2\pi)^3 \delta^{(3)}(\underbrace{k-k}_{=0}) \Big).
\end{equation}
%
Following the treatment \eqref{eq:ordinary_QM_harmonic_oscillator} of the ordinary QM harmonic oscillator above, we identify the associated self-adjoint harmonic oscillators \emph{dimensional} $\{q_k, p_k\}_k$ and \emph{adimensional} $\{\tilde{q}_k, \tilde{p}_k\}_k$ $k$-space-density variables\footnote{In the sense that they are (a)-dimensional square-root densities in Fourier space, that is $\propto\, k^{-3/2}$.} as
\begin{align}
    q_k(t_0) &= \frac{1}{\sqrt{\omega_k}} \tilde{q}_k(t_0)=\frac{1}{\sqrt{2\omega_k}} (a_k + a_k^{\dagger}), \quad
    p_k(t_0) = \sqrt{\omega_k}\, \tilde{p}_k(t_0)=-i \sqrt{\frac{\omega_k}{2}} (a_k - a_k^{\dagger}).
\end{align}
The fields are thus expressed as
\begin{align}\label{eq:relations_fields_creation_operators_harmonic_oscillator_var}
    \phi_k(t_0) &= \frac{1}{\sqrt{2\omega_k}} (a_k + a_{-k}^{\dagger}) 
    \\
    &= \frac{1}{\sqrt{2\omega_k}}\Big[ \big(\tilde{q}_k+\tilde{q}_{-k}\big) + i \big(\tilde{p}_k - \tilde{p}_{-k}\big) \Big]
    = \tfrac{1}{\sqrt{2}}\Big[ \big({q}_k+{q}_{-k}\big) + \tfrac{i}{\omega_k}\big({p}_k - {p}_{-k}\big) \Big]
    \\
    \pi_k(t_0) &= -i \sqrt{\frac{\omega_k}{2}} (a_k - a_{-k}^{\dagger}) \\
    &= \sqrt{\frac{\omega_k}{2}} \Big(\tilde{p}_k + \tilde{p}_{-k}\Big) - i \sqrt{\frac{\omega_k}{2}} \Big( \tilde{q}_k- \tilde{q}_{-k} \Big)
    = \tfrac{1}{\sqrt{2}}\Big[ \big({p}_k - {p}_{-k}\big) -i\,\omega_k\big({q}_k-{q}_{-k}\big)\Big].
\end{align}
Note that we could have \emph{completely equivalently} started from self-adjoint oscillators $\{q_k, p_k\}_k$, imposed the field operators are related to these oscillators as above in order to obey the CCR, and then defined creation and annihilation operators accordingly.

In any case, this decomposition highlights that the \textbf{truly observable DoFs of the Klein-Gordon field} are given by the self-adjoint harmonic oscillators $\{q_k, p_k\}_k$, or equivalently by the creation and annihilation operators $\{a_k, a_k^{\dagger}\}_k$, which indeed destroy or create quanta of the field with momentum $\bar{k}$ i.e. particles under suitable conditions, whereas the field Fourier modes $\phi_k$ and $\pi_k$ are \emph{complex} harmonic oscillators.

Is the above \textbf{decomposition unique}?
We could choose a different reference time $t_0$, but, as long as we are in a free theory in flat spacetime, this simply corresponds to a phase shift in the definition of creation and annihilation operators, leaving the vacuum invariant.
On the other hand, there are indeed inequivalent choices of creation and annihilation operators, for instance mixing $a_k$ and $a_{-k}^\dagger$.
This indeed changes the vacuum of the theory i.e. the state $|0\rangle$ annihilated by all $a_k$ operators.
This is not a problem in flat spacetime, where Poincaré invariance selects a preferred vacuum which happily also coincides with the ground state of the Hamiltonian, but it becomes a serious issue in curved spacetime, where no preferred vacuum exists in general. \todotag{Discuss issue in detail below}
%
\end{mytheorem}



\begin{mytheorem}[Infrared regularization \& DoFs of Klein-Gordon field]
%
To fix the conventions, we consider infrared regularization by placing the theory in a finite cubic box of volume $V=L^3$ with periodic boundary conditions.
Fourier modes become countable discrete $\mathbf{k} = \frac{2\pi}{L} \mathbf{n}$ with $\mathbf{n}\in\mathbb{Z}^3$, and we have the correspondences
\begin{align}\label{eq:IR_reg_replacements}
    \int_V \frac{d^3 k}{(2\pi)^3} &\,\,\Longrightarrow \,\,\frac{1}{V} \sum_k\,, \qquad
    (2\pi)^3 \delta^{(3)}(\mathbf{k} - \mathbf{k}') \equiv \int_V d^dx e^{i\mathbf{x}\cdot(\mathbf{k} - \mathbf{k}')} \,\,\Longrightarrow \,\,V \delta_{k,k'} \,.
\end{align}
The Fourier transforms of fields and of the Hamiltonian become
\begin{align}
    \phi(t_0,\mathbf{x})&= \frac{1}{V} \sum_k e^{i \mathbf{k}\cdot\mathbf{x}} \phi_k(t_0) = \frac{1}{V} \sum_k \frac{1}{\sqrt{2\omega_k}} \left( a_k e^{i \mathbf{k}\cdot\mathbf{x}} + a_k^{\dagger} e^{- i \mathbf{k}\cdot\mathbf{x}} \right),
    \\
    \pi(t_0,\mathbf{x})&= \frac{1}{V} \sum_k e^{i \mathbf{k}\cdot\mathbf{x}} \pi_k(t_0) = \frac{1}{V} \sum_k \frac{1}{\sqrt{2\omega_k}} \left( -i \omega_k a_k e^{i \mathbf{k}\cdot\mathbf{x}} + i \omega_k a_k^{\dagger} e^{- i \mathbf{k}\cdot\mathbf{x}} \right),
    \\
    H&= \frac{1}{V} \sum_k \hbar \omega_k \left( a_k^{\dagger} a_k + \tfrac{1}{2} V \right).
\end{align}
%
With the above conventions, \textbf{all the previous formulas are unchanged upon the replacements} \eqref{eq:IR_reg_replacements}.
The nonzero commutation relations become
\begin{align}
    [\phi_k(t), \pi_{k'}(t)] = i\hbar\, V \delta_{k,k'}, \quad
    [a_{k}, a_{k'}^{\dagger}] = V \delta_{k,k'}.
\end{align}
The \textbf{energy dimensions of} creation/annihilation \textbf{operators} $\{a_k,a_k^\dagger\}_k$, dimensional $\{q_k, p_k\}_k$ and adimensional $\{\tilde{q}_k, \tilde{p}_k\}_k$ harmonic oscillators variables, \textbf{and their mutual relations} \eqref{eq:relations_fields_creation_operators_harmonic_oscillator_var} \textbf{remain unchanged}.

%
\textbf{Beware} in the \textbf{literature} it is \textbf{common to rescale} operators by $\sqrt{V}$ after IR regularization as
\begin{align}
    a_k &\mapsto V^{-\frac{1}{2}} a_k, \quad a_k^{\dagger} \mapsto V^{-\frac{1}{2}} a_k^{\dagger}, \quad
    q_k \mapsto V^{-\frac{1}{2}} q_k, \quad p_k \mapsto V^{-\frac{1}{2}} p_k, \quad
    \tilde{q}_k \mapsto V^{-\frac{1}{2}} \tilde{q}_k, \quad \tilde{p}_k \mapsto V^{-\frac{1}{2}} \tilde{p}_k,
\end{align}
so that indeed $a_k$ and $a_k^{\dagger}$ become dimensionless operators obeying $[a_k, a_{k'}^{\dagger}] = \delta_{k,k'}$.
The fields and Hamiltonian would then read
\begin{align}
    \phi(t_0,\mathbf{x})&= \frac{1}{\sqrt{V}} \sum_k e^{i \mathbf{k}\cdot\mathbf{x}} \frac{1}{\sqrt{2\omega_k}} \left( a_k e^{i \mathbf{k}\cdot\mathbf{x}} + a_k^{\dagger} e^{- i \mathbf{k}\cdot\mathbf{x}} \right),
    \\
    \pi(t_0,\mathbf{x})&= \frac{1}{\sqrt{V}} \sum_k e^{i \mathbf{k}\cdot\mathbf{x}} \frac{1}{\sqrt{2\omega_k}} \left( -i \omega_k a_k e^{i \mathbf{k}\cdot\mathbf{x}} + i \omega_k a_k^{\dagger} e^{- i \mathbf{k}\cdot\mathbf{x}} \right),
    \\
    H&= \sum_k \hbar \omega_k \left( a_k^{\dagger} a_k + \tfrac{1}{2} \right).
\end{align}
%
This is just a matter of conventions, but it is important to keep track of factors of $V$ when considering fluctuations and zero-point energies.
We will \textbf{not adopt this convention}, which make the passage to the continuum somewhat less straightforward.
%
\end{mytheorem}

%-------------------------------------------------------------------

\begin{mytheorem}[Hilbert spaces for mode $k$ harmonic oscillators of the Klein-Gordon field]
%
Impose some IR regularization, so that Fourier modes $k$ are countable discrete and Fourier trasnforms change as discussed in \eqref{eq:IR_reg_replacements} above.
%
When the field $\phi(t,\mathbf{x})$ is expressed in the space variable $\mathbf{x}$ we can identify\footnote{provided the conditions indeed are such that it actually makes sense to talk about particles} a single-particle Hilbert space of the form $\mathcal{H}_1\simeq L^2_{\mathbf{x}}(\R^3)$ and corresponding $n$-particle Hilbert spaces $\mathcal{H}_1^{\otimes^n}$ for excitations with \emph{definite position} $\mathbf{x}$ i.e. particles.
%
On the other hand, decomposing the Klein-Gordon field into its constituting uncoupled harmonic oscillators $\phi(t,\mathbf{x})\sim \int d^dk\, \phi_k(t)$, we can identify Hilberts spaces $\mathcal{M}_k$ for excitations with \emph{definite momentum} $k$ which allows for a varying number of quanta (particles) i.e. the Hilberts spaces of each harmonic oscillator.
%
The Fock space is equivalently decomposed as direct sum
\begin{align}
    \mathcal{F}=\bigoplus_{n=0}^\infty \mathcal{H}_1^{\otimes^n}=\bigoplus_{k\,\in\mathrm{modes}}\mathcal{M}_k\,.
\end{align}
%

For each mode $k$ we can consider the representations of the Hilbert space $\mathcal{M}_k$ in real or Fourier space\footnote{We would naively call them position and momentum representations, but this is somewhat a misnomer since `position' rather means the elongation of the oscillator with momentum $k$ and 'momentum' means the conjugate variable.} i.e. use a basis of eigenvectors of the operators $q_k$ or $p_k$ respectively.
%
For the sake of clarity, since operators have dimensions $[q_k]=E^{-1/2} E^{-d/2}$ and $[p_k]=E^{1/2} E^{-d/2}$ different from ordinary 1D oscillators due to our conventions, we label the two Hilbert bases with truly adimensional variables $\xi_k, \eta_k\in\R$, that is $[\xi_k]=E[\eta_k]=E^0$ related to the operators respectively as
\begin{align}
    \begin{cases}
    q_k=\omega_k^{-1/2}\,\tilde{q}_k =\omega_k^{-1/2}\, V^{1/2}\xi_k\,,\\[6pt]
    p_k=\omega_k^{1/2}\,\tilde{p}_k = -i \omega_k^{1/2}\, V^{1/2} \partial_{\xi_k}\,,
    \end{cases}
    \qquad\text{and}\qquad
    \begin{cases}
    q_k=\omega_k^{-1/2}\,\tilde{q}_k = i \omega_k^{-1/2}\, V^{-1/2}\partial_{\eta_k}\,,\\[6pt]
    p_k=\omega_k^{1/2}\,\tilde{p}_k = \omega_k^{1/2}\, V^{-1/2} \eta_k\,.
    \end{cases}
\end{align}
%
In the two bases $|\xi_k\rangle\equiv |q_k\rangle$  and $|\eta_k\rangle\equiv |p_k\rangle$ the operators act as multiplication and differentiation, and viceversa, respectively
\begin{align}
\begin{aligned}
    \hat{q}_k | \xi_k \rangle &= \omega_k^{-1/2} V^{1/2} \xi_k | \xi_k \rangle, \qquad\qquad
    \hat{p}_k | \xi_k \rangle = -i \omega_k^{1/2} V^{1/2} \frac{\partial}{\partial \xi_k} | \xi_k \rangle,
    \\
    \hat{q}_k | \eta_k \rangle &= i \omega_k^{-1/2} V^{-1/2} \frac{\partial}{\partial \eta_k} | \eta_k \rangle, \qquad
    \hat{p}_k | \eta_k \rangle = \omega_k^{1/2} V^{-1/2} \eta_k | \eta_k \rangle.
\end{aligned}
\end{align}
%
The overlap between the two bases, as confirmed by acting explicitly with either operator, is
\begin{align}
    \langle q_k | p_k \rangle &= \tfrac{1}{2\pi}e^{i \xi_k\eta_k}= \tfrac{1}{2\pi}e^{i V q_k p_k}.
\end{align}


In the real representation, the \emph{normalized} wave function of the $n_k$th excited state $|n_k\rangle$ is
\begin{align}
    \langle q_{k} | n_k \rangle =:
     \psi_{n_k}(q_{k}) 
     &= \frac{1}{\sqrt{n_k!}}\Big[\tfrac{1}{\sqrt{2}}\big(\xi_k-\partial_{\xi_k}\big)\Big]^{n_k} \left( \tfrac{1}{\pi} \right)^{\frac{1}{4}} e^{-\frac{1}{2}\xi_k^2} 
     \\
     &=:  \frac{1}{\sqrt{2^{n_k}n_k!}} H_{n_k}(\xi_k) \cdot \left( \tfrac{1}{\pi} \right)^{\frac{1}{4}} e^{-\frac{1}{2}\xi_k^2}
     \\
     &= \frac{1}{\sqrt{2^{n_k}n_k!}} H_{n_k}(\text{\scriptsize $V^{-1/2}\omega_k^{1/2}q_k$}) \cdot \left( \tfrac{1}{\pi} \right)^{\frac{1}{4}} e^{-\frac{1}{2}V^{-1} \omega_k q_k^2}\,.
\end{align}
In the conjugate representation the \emph{normalized} wave function of $|n_k\rangle$ reads
\begin{align}
    \langle p_{k} | n_k \rangle =:
     \tilde{\psi}_{n_k}(p_{k}) 
     &= \frac{1}{\sqrt{n_k!}}\Big[\tfrac{(-i)}{\sqrt{2}}\big(\eta_k-\partial_{\eta_k}\big)\Big]^{n_k} \left(\tfrac{1}{\pi}\right)^{\frac{1}{4}} e^{-\frac{1}{2}\eta_k^2} 
     \\
     &=: \frac{(-i)^{n_k}}{\sqrt{2^{n_k}n_k!}} H_{n_k}(\eta_k) \cdot \left(\tfrac{1}{\pi}\right)^{\frac{1}{4}} e^{-\frac{1}{2}\eta_k^2}
     \\
     &= \frac{1}{\sqrt{2^{n_k}n_k!}} H_{n_k}(\text{\scriptsize $V^{-1/2}\omega_k^{-1/2}p_k$}) \cdot \left( \tfrac{1}{\pi} \right)^{\frac{1}{4}} e^{-\frac{1}{2}V^{-1} \omega_k^{-1} p_k^2}
\end{align}
%
This is confirmed explicitly by inserting a resolution of the identity and the explicit overlap between the two bases.
Using that $\xi_k\mapsto i \partial_{\eta_k}$ and $\partial_{\xi_k} \mapsto i \eta_k$ under Fourier transform, we find
\begin{align}
    \langle p_{k} | n_k \rangle = 
     &= \int \!\!d q_k \, \,\langle p_k | q_k \rangle \,\,\langle q_k | n_k \rangle
     \\
     &= \int_\R\!\!\! d\xi_k\, \tfrac{1}{2\pi}e^{-i \xi_k\eta_k} \,\,\underbrace{\frac{1}{\sqrt{n_k!}}\Big[\tfrac{1}{\sqrt{2}}\big(\xi_k-\partial_{\xi_k}\big)\Big]^{n_k} \left(\tfrac{1}{\pi}\right)^{\frac{1}{4}} e^{-\frac{1}{2}\xi_k^2}}_{= \frac{1}{\sqrt{2^{n_k}n_k!}} H_{n_k}\!(\xi_k) \cdot \left(\tfrac{1}{\pi}\right)^{\frac{1}{4}} e^{-\frac{1}{2}\xi_k^2}}
     \\
     &= \int_\R\!\!\!  d\xi_k\, \tfrac{1}{2\pi}e^{-i \xi_k\eta_k} \frac{1}{\sqrt{n_k!}}\Big[(-i)\tfrac{1}{\sqrt{2}}\big(\eta_k-\partial_{\eta_k}\big)\Big]^{n_k} \left(\tfrac{1}{\pi}\right)^{\frac{1}{4}} e^{-\frac{1}{2}\xi_k^2}
     \\
     &= \frac{(-i)^{n_k}}{\sqrt{n_k!}}\Big[\tfrac{1}{\sqrt{2}}\big(\eta_k-\partial_{\eta_k}\big)\Big]^{n_k} \left(\tfrac{1}{\pi}\right)^{\frac{1}{4}} \int_\R\!\!\!  d\xi_k\, \tfrac{1}{2\pi}e^{-i \xi_k\eta_k}  e^{-\frac{1}{2}\xi_k^2}
     \\
     &= \frac{(-i)^{n_k}}{\sqrt{n_k!}}\Big[\tfrac{1}{\sqrt{2}}\big(\eta_k-\partial_{\eta_k}\big)\Big]^{n_k} \left(\tfrac{1}{\pi}\right)^{\frac{1}{4}} e^{-\frac{1}{2}\eta_k^2}
     \\
     &=: \frac{(-i)^{n_k}}{\sqrt{2^{n_k}n_k!}} H_{n_k}(\eta_k) \cdot \left(\tfrac{1}{\pi}\right)^{\frac{1}{4}} e^{-\frac{1}{2}\eta_k^2}
     \\
     &= \frac{(-i)^{n_k}}{\sqrt{2^{n_k}n_k!}} H_{n_k}\!(\text{\scriptsize $V^{-1/2}\omega_k^{-1/2}p_k$}) \cdot \left(\tfrac{1}{\pi}\right)^{\frac{1}{4}} e^{-\frac{1}{2}V^{-1} \omega_k^{-1} p_k^2}\,.
\end{align}
%

Finally we compute the wave function for the Fourier transformed field 
\begin{align}
    \hat{\phi}_k=\tfrac{1}{\sqrt{2}}\Big[ \big(\hat{q}_k+\hat{q}_{-k}\big) + \tfrac{i}{\omega_k}\big(\hat{p}_k - \hat{p}_{-k}\big) \Big]\quad \text{acting on}\quad \mathcal{M}_k\oplus \mathcal{M}_{-k}\,.
\end{align}
%
The operator $\hat{\phi}_k$ is \emph{not} self-adjoint, but it is \emph{normal}, so that we can still find a Hilbert basis of  $\mathcal{M}_k\oplus \mathcal{M}_{-k}$ made of eigenstates $|f_k\rangle$ of $\phi_k$ with \emph{complex} eigenvalues $f_k\in\C$.
%
Indeed it is sufficient to consider a spectral basis for the two self-adjoint \emph{commuting} operators
\begin{align}
    \hat{X}_k := \frac{1}{\sqrt{2}} ({q}_k + {q}_{-k} ), \quad
    \hat{Y}_k := \frac{1}{\omega_k}\frac{1}{\sqrt{2}} ({p}_k - {p}_{-k} ), \quad
    [\hat{X}_k, \hat{Y}_k]=0\,.
\end{align}
Joint eigenstates $|x_k, y_k\rangle$ of $\hat{X}_k$ and $\hat{Y}_k$ with real eigenvalues $x_k, y_k\in\R$ are also eigenstates of $\phi_k$ with complex eigenvalues $f_k = x_k + i y_k\in\C$.
%

Practically it is convenient to work with the two \emph{rotated} harmonic oscillators 
\begin{align}
    &Q_+ := \frac{1}{\sqrt{2}} (q_k + q_{-k}), \quad P_+ := \frac{1}{\sqrt{2}} (p_k + p_{-k}), \quad a_+^{(\dagger)} := \frac{1}{\sqrt{2}} (a_k^{(\dagger)} + a_{-k}^{(\dagger)})\,,
    \\
    &Q_- := \frac{1}{\sqrt{2}} (q_k - q_{-k}), \quad P_- := \frac{1}{\sqrt{2}} (p_k - p_{-k})\,\quad a_-^{(\dagger)} := \frac{1}{\sqrt{2}} (a_k^{(\dagger)} - a_{-k}^{(\dagger)})\,.
\end{align}
%
The rotated oscillators {\small $(Q_+, P_+)$} and {\small $(Q_-, P_-)$} are still decoupled, since {\small $[Q_+, P_-]=[Q_-, P_+]=0$} i.e. {\small $[a_+, a_-]=[a_+, a_-^{\dagger}]=0$}.
%
The two vacua conincide {\small $|0_k, 0_{-k}\rangle \equiv |0_+, 0_-\rangle$} and pure tensor states of the original and of the rotated oscillators are related by Clebsch-Gordan coefficients as
{\small
\begin{align}
    |n_k, n_{-k}\rangle &:= \frac{(a_k^{\dagger})^{n_k}}{\sqrt{n_k!}} \frac{(a_{-k}^{\dagger})^{n_{-k}}}{\sqrt{n_{-k}!}} |0_k, 0_{-k}\rangle
    \\
    &= \frac{1}{\sqrt{n_k!\, n_{-k}!}} \left( \frac{a_+^{\dagger} + a_-^{\dagger}}{\sqrt{2}} \right)^{n_k} \left( \frac{a_+^{\dagger} - a_-^{\dagger}}{\sqrt{2}} \right)^{n_{-k}} |0_+, 0_-\rangle
    \\
    &= \frac{1}{\sqrt{n_k!\, n_{-k}!}} \frac{1}{{2^{(n_k + n_{-k})/2}}}\sum_{m=0}^{n_k} \sum_{l=0}^{n_{-k}} \binom{n_k}{m} \binom{n_{-k}}{l} (a_+^{\dagger})^{m+l}\, (a_-^{\dagger})^{n_k + n_{-k} - (m+l)} |0_+, 0_-\rangle
    \\
    &=: \sum_{m=0}^{n_k} \sum_{l=0}^{n_{-k}} \binom{n_k}{m} \binom{n_{-k}}{l}\sqrt{\frac{(m+l)!\, (n_k + n_{-k} - (m+l))!}{n_k!\, n_{-k}!\, 2^{(n_k+n_{-k})}}}\,\,| m+l, n_k + n_{-k} - (m+l)\rangle_{\pm}\,.
\end{align}
}

Mimicking the above treatment for the mode $k$ oscillator, denote adimensional variables
\begin{align}
    &\xi_+ := V^{-1/2} \omega_k^{1/2} Q_+ = \frac{1}{\sqrt{2}}(\xi_k + \xi_{-k}), \quad
    \xi_- := V^{-1/2} \omega_k^{1/2} Q_- = \frac{1}{\sqrt{2}}(\xi_k - \xi_{-k}), \\
    &\eta_+ := V^{-1/2} \omega_k^{-1/2} P_+ = \frac{1}{\sqrt{2}}(\eta_k + \eta_{-k}), \quad
    \eta_- := V^{-1/2} \omega_k^{-1/2} P_- = \frac{1}{\sqrt{2}}(\eta_k - \eta_{-k})\,,
\end{align}
%
and corresponding spectral bases $\{|\xi_{\pm}\rangle\}$ for $Q_{\pm}$ and $\{|\eta_{\pm}\rangle\}$ for $P_{\pm}$ of the Hilbert space of the first (resp. second) rotated oscillator.
%
In these representations the wave functions reads 
\begin{align}
    \langle \xi_{\pm} | n_{\pm} \rangle & = \frac{1}{\sqrt{n_{\pm}!}}  \Big[\tfrac{1}{\sqrt{2}}\big(\xi_\pm-\partial_{\xi_\pm}\big)\Big]^{n_\pm} \left( \tfrac{1}{\pi} \right)^{\frac{1}{4}} e^{-\frac{1}{2}\xi_{\pm}^2}
    =\frac{1}{\sqrt{2^{n_{\pm}} \,n_{\pm}!}} H_{n_{\pm}}(\xi_{\pm}) \cdot \left( \tfrac{1}{\pi} \right)^{\frac{1}{4}} e^{-\frac{1}{2}\xi_{\pm}^2}\,,
    \\
    \langle \eta_{\pm} | n_{\pm} \rangle &= \frac{1}{\sqrt{n_{\pm}!}} \Big[\tfrac{(-i)}{\sqrt{2}}\big(\eta_\pm-\partial_{\eta_\pm}\big)\Big]^{n_\pm} \left(\tfrac{1}{\pi}\right)^{\frac{1}{4}} e^{-\frac{1}{2}\eta_{\pm}^2}
    = \frac{(-i)^{n_{\pm}}}{\sqrt{2^{n_{\pm}} \,n_{\pm}!}} H_{n_{\pm}}(\eta_{\pm}) \cdot \left( \tfrac{1}{\pi} \right)^{\frac{1}{4}} e^{-\frac{1}{2}\eta_{\pm}^2}\,.
\end{align}
%
We are interested in tensor states $|f_k\rangle \equiv |\xi_+\rangle \otimes |\eta_-\rangle$ which are eigenstates of $\hat{\phi}_k$ with eigenvalue 
\begin{align}
    \hat{\phi}_k |f_k\rangle =  f_k |f_k\rangle\, = V^{1/2} \omega_k^{-1/2}\, (\xi_+ + i \eta_-)\, |f_k\rangle\,.
\end{align}
%
The probability amplitude (density) of measuring the value $f_k\in\C$ for the Fourier transformed field $\hat{\phi}_k$, i.e. the wave function for the state $|n_+,n_-\rangle_{\pm}$ of the rotated harmonic oscillators in the mixed\footnote{in the sense that these are joint eigenstate of $Q_+$ and $P_-$} representation $|f_k\rangle=|\xi_+ \rangle \otimes |\eta_- \rangle$ of $\mathcal{M}_+\oplus \mathcal{M}_-$ is given by 
\begin{align}
    \langle f_k | n_+, n_- \rangle_{\pm} 
    &= \langle \xi_+ | n_+ \rangle \cdot \langle \eta_- | n_- \rangle
    \\
    &= \frac{1}{\sqrt{2^{n_+} \,n_+!}} H_{n_+}\!(\xi_+) \cdot \left( \tfrac{1}{\pi} \right)^{\frac{1}{4}} e^{-\frac{1}{2}\xi_{+}^2} \cdot \frac{(-i)^{n_-}}{\sqrt{2^{n_-} \,n_-!}} H_{n_-}\!(\eta_-) \cdot \left( \tfrac{1}{\pi} \right)^{\frac{1}{4}} e^{-\frac{1}{2}\eta_{-}^2}
    \\
    &= \frac{(-i)^{n_-}}{\sqrt{2^{(n_+ + n_-)} \,n_+!\, n_-!}} H_{n_+}\!(\xi_+)\, H_{n_-}\!(\eta_-) \cdot \left( \tfrac{1}{\pi} \right)^{\frac{1}{2}} e^{-\frac{1}{2}(\xi_{+}^2 + \eta_{-}^2)}\,.
\end{align}
%
Finally we find the wave function of the state $|n_k, n_{-k}\rangle$ of the original oscillators in the representation $|f_k\rangle$ of $\mathcal{M}_k\oplus \mathcal{M}_{-k}$ by inserting a resolution of the identity in the rotated basis or equivalently using the Clebsch-Gordan coefficients above,
{\small
\begin{align}
    \langle f_k | n_k, n_{-k} \rangle 
    &= \sum_{m=0}^{n_k} \sum_{l=0}^{n_{-k}} \binom{n_k}{m} \binom{n_{-k}}{l}\sqrt{\frac{(m+l)!\, (n_k + n_{-k} - (m+l))!}{n_k!\, n_{-k}!\, 2^{(n_k+n_{-k})}}}\,\,\langle f_k | m+l, n_k + n_{-k} - (m+l)\rangle_{\pm}
    \\
    &= \sum_{m=0}^{n_k} \sum_{l=0}^{n_{-k}} \binom{n_k}{m} \binom{n_{-k}}{l}\sqrt{\frac{(m+l)!\, (n_k + n_{-k} - (m+l))!}{n_k!\, n_{-k}!\, 2^{(n_k+n_{-k})}}}
    \\
    &\quad \times \frac{(-i)^{n_k + n_{-k} - (m+l)}}{\sqrt{2^{(n_k + n_{-k})} \,(m+l)!\, (n_k + n_{-k} - (m+l))!}} H_{m+l}(\xi_+)\, H_{n_k + n_{-k} - (m+l)}(\eta_-) \cdot \left( \tfrac{1}{\pi} \right)^{\frac{1}{2}} e^{-\frac{1}{2}(\xi_{+}^2 + \eta_{-}^2)}
    \\
    &= \left( \tfrac{1}{\pi} \right)^{\frac{1}{2}} e^{-\frac{1}{2}(\xi_{+}^2 + \eta_{-}^2)} \frac{1}{\sqrt{n_k!\, n_{-k}!}} \frac{1}{2^{(n_k + n_{-k})}} 
    \\
    &\qquad\times \sum_{m=0}^{n_k} \sum_{l=0}^{n_{-k}} \binom{n_k}{m} \binom{n_{-k}}{l} (-i)^{n_k + n_{-k} - m-l} H_{m+l}(\xi_+)\, H_{n_k + n_{-k} - m-l}(\eta_-)
    \\
    &= \left( \tfrac{1}{\pi} \right)^{\frac{1}{2}} e^{-\frac{1}{2V}\omega_k |f_k|^2} \frac{1}{\sqrt{n_k!\, n_{-k}!}} \frac{1}{2^{(n_k + n_{-k})}}
    \\
    &\qquad\times \sum_{m=0}^{n_k} \sum_{l=0}^{n_{-k}} \binom{n_k}{m} \binom{n_{-k}}{l} (-i)^{n_k + n_{-k} - m-l} H_{m+l}(\xi_+)\, H_{n_k + n_{-k} - m-l}(\eta_-)\,
\end{align}
}
This is the probability amplitude (density) of measuring the value $f_k\in\C$ for the Fourier transformed field $\hat{\phi}_k$ when the two original oscillators $k, -k$ are in the state $|n_k, n_{-k}\rangle$.
%
The corresponding probability (density) is simply the modulus squared of the above expression
{\small
\begin{align}
    P_{n_k, n_{-k}}(f_k) \,df_k &= |\langle f_k | n_k, n_{-k} \rangle|^2 \,df_k\,
    \\
    &= \left( \tfrac{1}{\pi} \right) e^{-\frac{1}{V}\omega_k |f_k|^2} \frac{1}{n_k!\, n_{-k}!} \frac{1}{2^{2(n_k + n_{-k})}}
    \\
    &\quad \times \left| \sum_{m=0}^{n_k} \sum_{l=0}^{n_{-k}} \binom{n_k}{m} \binom{n_{-k}}{l} H_{m+l}(\xi_+)\, H_{n_k + n_{-k} - m-l}(\eta_-) \right|^2 \,df_k\,.
\end{align}
}
\end{mytheorem}




%------------------------------------------------------------

\begin{mytheorem}[Fluctuations of the Klein-Gordon field in momentum \& position space\todotag{Huge fix needed}]
%
{\color{red}
Here there is a mistake $\phi_k$ is a complex oscillator.
The states $n_k$ you are referring to are not eigenstates of $\phi_k$ but of the real and imaginary parts separately. You need to rewrite everything in terms of real oscillators $q_k, p_k$ or creation-annihilation operators $a_k, a_k^\dagger$.
Then in turn you will find the wave functional in momentum space $\Psi[\{\phi_k\}_k]$ and in position space $\Psi[\{\phi(x)\}_x]$ and the associated probabilities expanding $\phi_k$ in terms of its \emph{real} oscillator constitutents.
}

Having decomposed the Klein-Gordon field into its constituting uncoupled harmonic oscillators, we can assume each oscillator is in a state with a given number of quanta, and then immediately compute the corresponding field fluctuations i.e. the probability of finding a given set of Fourier modes $\{\phi_k\}$ or equivalently field values $\{\phi(x)\}$.
We could consider the vacuum state $|0\rangle$ where all oscillators are in their ground state, excited states $|n_{k_1}\dots n_{k_m}\dots \rangle$ with $n_k$ quanta in the mode $k$, coherent states $|\{\alpha_k\}\rangle$ or arbitrary entangled states.

Impose some IR regularization, so that Fourier modes $k$ are countable discrete and Fourier trasnforms change as discussed in \eqref{eq:IR_reg_replacements} above.
%
Assume the field is in the pure tensor state with $n_k$ quanta in the mode $k$ i.e. the harmonic oscillator labelled by $k$ is in the $n_k$-th excited state,
\begin{equation}
    |\Psi\rangle \equiv |n_{k_1}\dots n_{k_m}\dots \rangle.
\end{equation}
%

{\color{red}
Finally, we can compute the probability density of finding the Fourier mode $\vec{k}$ of the field with modulus  value between $\phi_k$ and $\phi_k + d\phi_k$ is
\begin{align}
    P_{n_k}(\phi_k) d\phi_k &= |\psi_{n_k}(\phi_k)|^2 d\phi_k \\
    &= \left( \frac{m \omega_k}{\pi \hbar} \right)^{1/2} \frac{1}{2^{n_k} n_k!} \left[ H_{n_k}\left( \sqrt{\frac{m \omega_k}{\hbar}} \phi_{k} \right) \right]^2 e^{-\frac{m \omega_k}{\hbar} \phi_{k}^2} \,d\phi_k.
\end{align}

%
The wave \emph{functional} $\Psi$ in momentum space is simply the product of all wave functions,
\begin{equation}
    \Psi\big[\{\phi_k\}_k\big] = \langle \{\phi_k\}_k | \Psi \rangle = \prod_k \psi_{n_k}(\phi_k).
\end{equation}
The probability density of finding a given field configuration $\{\phi_k\}_k$ in \emph{momentum} space is thus
\begin{align}
    P_{\Psi}(\{\phi_k\}_k) \,\,D\phi &= |\langle \{\phi_k\}_k | \Psi \rangle|^2 \,D\phi 
    = \prod_k |\psi_{n_k}(\phi_k)|^2 \,d\phi_k
    \\
    &= \prod_k \left( \frac{m \omega_k}{\pi \hbar} \right)^{1/2} \frac{1}{2^{n_k} n_k!} \left[ H_{n_k}\left( \sqrt{\frac{m \omega_k}{\hbar}} \phi_{k} \right) \right]^2 e^{-\frac{m \omega_k}{\hbar} \phi_{k}^2} \,d\phi_k,
\end{align}
where $D\phi = \prod_xd \phi(x) = \prod_k d\phi_k$ is the functional measure in the functional space of field configurations, equivalently expressed in terms of space values or Fourier modes.
%

The states $|\{\phi_k\}_k \rangle \equiv |\{\phi(x)\}_x\rangle$ form a basis of common eigenstates of all the field operators at equal time in both position $\{\hat{\phi}(t,x)\}_x$ and momentum $\{\hat{\phi}_k(t)\}_k$ space.
Indeed if the state 
\begin{align}
    \hat{\phi}(y)&|\{\phi(x)\}_x\rangle = \phi(y) |\{\phi(x)\}_x\rangle, \quad \forall y, \\[6pt]
    \Rightarrow\,\, &
    \hat{\phi}_k(t)|\{\phi(x)\}_x\rangle = \int d^3 x\, e^{-i \mathbf{k}\mathbf{x}} \hat{\phi}(t, \mathbf{x}) |\{\phi(x)\}_x\rangle = \int d^3 x\, e^{-i \mathbf{k}\mathbf{x}} \phi(x) |\{\phi(x)\}_x\rangle =
    \phi_k(t) |\{\phi(x)\}_x\rangle \quad \forall k.
\end{align}
%

Given such a $\hat{\phi}$-eigenstate $|\{f(x)\}_x\rangle$ with explicit \emph{position space consifguration}, we obtain the value of the wave functional on this state by inserting a resolution of the identity on the Fock space $\mathcal{F}$ with the spectral basis of $\hat{\phi}$ explicitated in terms of Fourier modes
\begin{align}
    \mathbb{I}_{\mathcal{F}}= \int D\phi_k \, |\{\phi_k\}_k \rangle \langle \{\phi_k\}_k |.
\end{align}
We immediately obtain
\begin{align}
    \Psi\big[\{f(x)\}_x\big] &= \langle \{f(x)\}_x | \Psi \rangle 
    = \int D\phi_k \, \langle \{f(x)\}_x | \{\phi_k\}_k \rangle \langle \{\phi_k\}_k | \Psi \rangle
    \\
    &= \int D\phi_k \, \prod_k \delta\left( \phi_k - f_k \right) \cdot \Psi\big[\{\phi_k\}_k\big]
    = \Psi\big[\{f_k\}_k\big], \quad \text{for}\quad f_k = \int d^3 x\, e^{-i \mathbf{k} \cdot \mathbf{x}} f(x).
\end{align}
In more practical terms, we simply obtain the Fourier modes of this field configuration
\begin{align}
    f_k=\int d^3 x\, e^{-i \mathbf{k} \cdot \mathbf{x}} f(x),
\end{align}
and we directly evaluate the wave function on the state $|\{f(x)\}_x\rangle\equiv |\{f_k\}_k\rangle$ itself expressing it via its Fourier space configuration.
%
The probability density of finding the field with configuration between $\{f(x)\}_x$ and $\{f(x)+df(x)\}_x$ is thus
\begin{align}
    P_{\Psi}(\{f(x)\}_x) \,Df &= |\Psi\big[\{f(x)\}_x\big]|^2 \,Df 
    = |\Psi\big[\{f_k\}_k\big]|^2 \,Df
    \\
    &= \prod_k \left( \frac{m \omega_k}{\pi \hbar} \right)^{1/2} \frac{1}{2^{n_k} n_k!} \left[ H_{n_k}\left( \sqrt{\frac{m \omega_k}{\hbar}} f_{k} \right) \right]^2 e^{-\frac{m \omega_k}{\hbar} f_{k}^2} \,Df,
\end{align}
where $Df$ is the functional measure in the function space of field configurations. 
%

We remark that nobody really knows what the function space of field configurations--i.e. of the $\hat{\phi}$-eigenvalue collections--should be, nor how to rigorously define the functional measure $Df$.
A naive guess is to consider the space of square-integrable functions $f(x) \in L^2(\mathbb{R}^3)$, but this is definitely not correct, as the typical field configurations are actually distributions rather than functions.
This is already evident from the vacuum fluctuations of the field, which diverge at every point in space.
Rigorous treatments of constructive QFT manage to define suitable function spaces and measures, but they are quite technical and beyond the scope of these notes.
%
}
\end{mytheorem}





%----------------------------------------------------------------
%===================================================================
\section{The Schrödinger equation in QFT}
%===================================================================
%----------------------------------------------------------------

The good old Schrödinger equation in Quantum Mechanics reads
\begin{equation}
    i \hbar \frac{\partial}{\partial t} |\psi(t)\rangle = \hat{H} |\psi(t)\rangle.
\end{equation}
In this formulation, it is bound to fail when dealing with systems with variable particle number.

However, as the Heisenberg and Schrödinger formulations of Quantum Mechanics are equivalent, we can still use the latter in Quantum Field Theory and get a corresponding equation.
The space $\mathcal{F}=\bigoplus \mathcal{H}^{\otimes n}$ of states in QFT is now a Fock space, i.e. a direct sum of $n$-particle Hilbert spaces.
Taking $\mathcal{H}\simeq L^2(\mathbb{R}^3)$ for simplicity, the general state in $\mathcal{F}$ reads
\begin{equation}
    |\Psi\rangle = \left( \begin{array}{c}
    \psi_0 \\
    \psi_1(\mathbf{x}_1) \\
    \psi_2(\mathbf{x}_1, \mathbf{x}_2) \\
    \vdots
    \end{array} \right),\qquad \psi_n(\mathbf{x}_1, \ldots, \mathbf{x}_n) \in L^2(\mathbb{R}^{3n}).
\end{equation}

The Schrödinger equation in QFT is virtually the same:
\begin{equation}
    i \hbar \frac{\partial}{\partial t} |\Psi(t)\rangle = \hat{H} |\Psi(t)\rangle.
\end{equation}
Here $\hat{H}=\int d^3x \mathcal{H}$ is the Hamiltonian operator acting on the Fock space $\mathcal{F}$, namely the space-integral of the Hamiltonian density operator $\mathcal{H}$.
For example, for the free Klein-Gordon field
\begin{align}
    \hat{H} &= \int d^3 x\, \left( \frac{1}{2} \hat{\pi}^2 + \frac{1}{2} (\nabla \hat{\phi})^2 + \frac{1}{2} m^2 \hat{\phi}^2 \right).
\end{align}


\begin{mytheorem}[Spectral basis \& maximal set of commuting observables.]
%
In ordinary QM, we can expand the state $|\Psi\rangle$ in terms of common eigenstates of suitable sets of commuting self-adjoint operators.
Common choices are the position operator $X$, the momentum $P$, the angular momentum $L^2$ and $L_z$, the Hamiltonian, the intrisinc spin $S^2$ and $S_z$ or suitable combinations like $L+S$, helicity, other instrinsic DoF operators, etc.

Given a set of commuting observables $\{A_i\}$, the spectral theorem indeed ensures the existence of a common spectral basis.
This basis might however have degeneracies i.e. independent eigenstates sharing the same collection of eigenvalues for all observables in the set.
A \emph{maximal set of commuting observables} is a collection of self-adjoint operators $\{A_i\}$ such that
\begin{itemize}
    \item $[A_i, A_j] = 0$ for all $i, j$;
    \item any other self-adjoint operator $B$ commuting with all $A_i$ is a function\footnote{e.g. $H\sim p^2/m$ in ordinary QM.} of the $A_i$.
\end{itemize}
The common eigenstates of a maximal set of commuting observables form a basis for the Hilbert space with no degeneracies i.e. two distinct eigenstates have different eigenvalues for at least one of the observables in the set.
\end{mytheorem}
\begin{proof}
Suppose there is a collection of eigenvalues $\{\lambda_i\}$ shared by two linearly independent eigenstates $|\psi\rangle$ and $|\phi\rangle$.
Then $S=\text{Span}\{|\psi\rangle, |\phi\rangle\}$ is a two-dimensional subspace invariant under all $A_i$ and we can define a new self-adjoint operator $B$ acting non-trivially only on this subspace and commuting with all $A_i$, contradicting the maximality of the set--e.g. it swaps $|\psi\rangle$ and $|\phi\rangle$ and is the identity on $S^{\perp}$.
\end{proof}


\begin{mytheorem}[Position \& momentum basis in QFT i.e. eigenstates of the field operators $\hat{\phi},\,\hat{\pi}$]
%
In a finite-dimensional QM system we have a finite number of DoFs, labelled by $i=1\dots n$, with generalized coordinates $q_i$ and conjugate momenta $p_i$ satisfying equal-time canonical commutation relations
\begin{align}
    [\hat{q}_i, \hat{p}_j] = i \hbar \delta_{ij}, \quad
    [\hat{q}_i, \hat{q}_j] = 0, \quad
    [\hat{p}_i, \hat{p}_j] = 0.
\end{align}
By the spectral theorem, we find common spectral bases for the position operators $q_1\dots q_n$ or momentum operators $p_1\dots p_n$, typically denoted $|q\rangle$ and $|p\rangle$ respectively.
%
The same can be done in Quantum Field Theory.
Here we have an infinite number of DoFs, often labelled by the spatial position $\mathbf{x} \in \mathbb{R}^3$, with generalized coordinates $\phi(\mathbf{x})$ and conjugate momenta $\pi(\mathbf{x})=\frac{\delta \mathcal{L}}{\delta \partial_t \phi(\mathbf{x})}$ satisfying analogous equal-time commutation relations 
\begin{align}
    [\hat{\phi}(t, \mathbf{x}), \hat{\pi}(t, \mathbf{y})] = i \hbar \,\delta^{(3)}(\mathbf{x} - \mathbf{y}), \quad
    [\hat{\phi}(t, \mathbf{x}), \hat{\phi}(t, \mathbf{y})] = 0, \quad
    [\hat{\pi}(t, \mathbf{x}), \hat{\pi}(t, \mathbf{y})] = 0.
\end{align}
%
At any fixed time $t$ the collections of operators $\{\hat{\phi}(t, \mathbf{x})\}_{\mathbf{x}\in \mathbb{R}^3}$ and $\{\hat{\pi}(t, \mathbf{x})\}_{\mathbf{x}\in \mathbb{R}^3}$ form two maximal\footnote{Ignoring further internal DoFs and considering $R^3$ for simplicity.} sets of commuting observables, and we can find corresponding spectral bases $\{|f\rangle\}_{f}$ and $\{|g\rangle\}_{g}$ of the Fock space.
%
These bases obey
\begin{align}
    \hat{\phi}(t, \mathbf{x}) |f\rangle &= f(\mathbf{x}) |f\rangle, \qquad
    \hat{\pi}(t, \mathbf{x}) |g\rangle = g(\mathbf{x}) |g\rangle.
\end{align}
That is, the states $|f\rangle$ have eigenvalue collections $\{f(x)\}_{x}$ for the commuting operators $\{\hat{\phi}(x)\}_x$, resp. $|g\rangle$ have $\{g(x)\}_x$ for $\{\hat{\pi}(x)\}_x$, for suitable functions $f,g:\mathbb{R}^3 \to \mathbb{R}$.
%
These bases are the field-theoretic analogue of the position $\{|x\rangle\}_{x\in \mathbb{R}^n}$ and momentum $\{|p\rangle\}_{p\in \mathbb{R}^n}$ bases in ordinary QM, since $\hat{\phi}(x)$ and $\hat{\pi}(x)$ are the counterpart of position $\hat{X}$ and momentum $\hat{P}$ operators.

We remark nobody really knows what is the \emph{space of field configurations.}
That is the function spaces the functions $f$ and $g$ belong to, i.e. the possible collections $\{f(x)\}_x$ or $\{g(x)\}_x$ of $\hat{\phi}$ or $\hat{\pi}$ eigenvalues.
A naive guess is to consider the space of square-integrable functions $f(x) \in L^2(\mathbb{R}^3)$, but this is definitely not correct, since the typical field configurations are actually distributions rather than functions.
This is already evident from the vacuum fluctuations of the field, which diverge at every point in space.
Rigorous treatments of constructive QFT manage to define suitable function spaces and measures, but they are quite technical and beyond the scope of these notes.
%


The $\hat{\phi}$ eigenstates, i.e. states $|f\rangle$ for some field configurations $f:\mathbb{R}^3\to\mathbb{R}$, can equivalently be expressed in terms of their Fourier modes.
Indeed the expressions $|\{f(x)\}_x\rangle\equiv |\{f_k\}_k\rangle$ denote the \emph{same} state $|f\rangle$ i.e. the same field configuration, simply explicitated in terms of position space values or Fourier modes.
This confirms the state $|f\rangle$ is also an eigenstate of the Fourier transformed field operators $\hat{\phi}_k(t)$ with its Fourier modes $f_k$ as eigenvalues.
Indeed, for fixed $k$ the operator $\hat{\phi}_k(t)$ is a linear combination of the $\{\hat{\phi}(t,x)\}_x$ operators and returns the corresponding linear combination $f_k$ of eigenvalues when acting on the state $|f\rangle$, namely
%
\begin{align}
    \hat{\phi}(x)&\,|f\rangle = f(x)\, |f\rangle \,\,\, \forall x\quad \Rightarrow\quad 
    \hat{\phi}_k(t)|f\rangle = \int d^3 x\, e^{-i \mathbf{k}\mathbf{x}} \hat{\phi}(t, \mathbf{x}) |f\rangle = \int d^3 x\, e^{-i \mathbf{k}\mathbf{x}} f(x) |f\rangle =
    f_k\,|f\rangle \quad \forall k.
\end{align}
%

The states $|f\rangle$, as $f$ varies in the (unknown, ill-defined) function space $W_{\phi}$ of field configurations, form an improper orthonormal basis of the Fock space $\mathcal{F}$.
We use them to get a resolution of the identity
\begin{align}
    \mathbb{I}_{\mathcal{F}}= \int_{W_{\phi}} \!\!\!Df\, \, |f \rangle \,\langle f |
     = \int_{W_{\phi}} Df_x \,\, |\{f(x)\}_x \rangle\, \langle \{f(x)\}_x | 
     = \int_{W_{\phi}} Df_k\, \, |\{f_k\}_k \rangle \,\langle \{f_k\}_k |.
\end{align}
Here $Df$ denotes the functional measure on the function space $W_{\phi}$, formally explicitated in terms of position values or Fourier modes as
\begin{align}
    Df = \prod_x df(x) \overset{!}{=}  \prod_k df_k.
\end{align}
The two expressions should coincide since the Fourier transform is expected to be a measure-preserving bijection between the two expression of the function space $W_{\phi}$.
%
The above expressions are made rigorous by introducing suitable infrared regularization, making the Fourier modes countable discrete, and ultraviolet cutoff, discarding Fourier modes above some scale $\Lambda$ and making the function space finite-dimensional.
%
In any case, concatenating the two possible expressions for the identity resolution gives the expected result
\begin{align}
    \mathbb{I}_{\mathcal{F}}&= \int_{W_{\phi}} Df \,\, |\{f(x)\}_x \rangle \,\langle \{f(x)\}_x | 
     = \int_{W_{\phi}} \int_{W_{\phi}} Df\, Df' \,\, |\{f(x)\}_x \rangle \,\langle \{f(x)\}_x |\{f'_k\}_k \rangle \langle \{f'_k\}_k |
     \\
     &= \int_{W_{\phi}} \int_{W_{\phi}} Df\, Df'\,\, \delta\left(f_k-f'_k\right) \,\, |\{f(x)\}_x \rangle \,\langle \{f'_k\}_k |
     =
     \int_{W_{\phi}}  Df' \,\, |\{f'_k\}_k \rangle\,\langle \{f'_k\}_k |
    =\mathbb{I}_{\mathcal{F}}.
\end{align}
%

Completely analogous results hold for the $\hat{\pi}$ operators and their eigenstates $|g\rangle$, where $g$ varies over the \emph{conjugate} field configuration space $W_{\pi}$ i.e. the space of possible collections $\{g(x)\}_x$ of $\hat{\pi}$ eigenvalues.
%
We pass from one basis to the other via a resolution of the identity\todotag{The overlap $\langle g|f\rangle$ is different in general!}
\begin{align}
    |g\rangle &= \int_{W_{\phi}} Df\,\, |f\rangle\, \langle f | g \rangle, {\color{red}\quad \text{with}\quad
    \langle f | g \rangle = \mathcal{N} e^{\frac{i}{\hbar} \int d^3 x\, f(x) g(x)}},
\end{align}


Given any state $|\Psi\rangle \in \mathcal{F}$, we can express it in either basis as
\begin{align}
    |\Psi\rangle &= \int_{W_{\phi}} Df\,\, |f\rangle \, \langle f | \Psi \rangle 
    = \int_{W_{\pi}} Dg\,\, |g\rangle \, \langle g | \Psi \rangle.
\end{align}
The functionals $\Psi[f] = \langle f | \Psi \rangle$ and $\Psi[g] = \langle g | \Psi \rangle$ are the \emph{wave functionals} of the state $|\Psi\rangle$ in the $\hat{\phi}$ and $\hat{\pi}$ representations respectively.
%
The value $\Psi[f]$ is the probability amplitude density of finding the field with configuration $f=\{f(x)\}_x\equiv\{f_k\}_k$ when the system is in the state $|\Psi\rangle$.
That is, with the above considerations on the functional measure $Df$, the probability density of finding the field with configuration between $f$ and $f+Df$ is
\begin{align}
    P_{\Psi}(f) \,Df &= |\langle f | \Psi \rangle|^2 \,Df = |\Psi[f]|^2 \,Df.
\end{align}
Analogous considerations hold for $\Psi[g]$ and $P_{\Psi}(\{g(x)\}_x) \,Dg$ in the $\hat{\pi}$ representation.
%
\end{mytheorem}


\begin{mytheorem}[Collapse of the wave functional \& measuring the $\phi$-field configuration at all space points at once]
%
The postulates of QM state that after measuring an observable $A$ on a system in state $|\Psi\rangle$ obtaining the eigenvalue $\lambda$ as outcome, the system collapses to the corresponding eigenspace of $A$.
For example, if we measure the field $\hat{\phi}$ at some points $x_1\dots x_n$ in space obtaining values $f(x_1)\dots f(x_n)$, the system will then collapse onto the eigenspace of states $|\tilde{\Psi}\rangle$ satisfying
\begin{align}
    \hat{\phi}(x_i) |\tilde{\Psi}\rangle = f(x_i) |\tilde{\Psi}\rangle, \quad i=1\dots n.
\end{align}

In fact, since the entire collection of field operators $\{\hat{\phi}(x)\}_{x\in \mathbb{R}^3}$ commutes (it is actually a maximal set of commuting observables), we could in principle measure the field values $\langle|\hat{\phi}(t_0,x)\rangle$ at each point in space at the same time $t_0$.
In this case, the system will collapse onto a unique field eigenstate $|f\rangle$ for a fixed configuration $f:\mathbb{R}^3 \to \mathbb{R}$.
Repeating the measurement immediately afterwards will yield the same configuration $f(x)$ with probability one, i.e. the probability density of finding the field with configuration between $\{f'(x)\}_x$ and $\{f'(x)+df'(x)\}_x$ after the measurement is
\begin{align}
    P_{\text{after}}(\{f'(x)\}_x) \,Df &= |\langle f' | f \rangle|^2 \,Df = \delta(f' - f)^2 \,Df,
\end{align}
with the obvious caveat on the ill-defined square of the delta functional.

Such an infinite measurement is of course purely theoretical and practically almost impossible.
However, it is worth noticing that such a measurement has in fact been performed by gravity and matter at the end of inflation, collapsing the quantum fluctuations of the inflaton field into classical inhomogeneities and seeding structure formation. \todotag{Expand on this (cf. kemps qft L4)}
\end{mytheorem}


\begin{mytheorem}[Operators in the field representations\todotag{fix \& finish}]
%
Just like in ordinary QM, the field operators act on functionals of the $\phi$-field configurations as functional multiplication and functional differentiation operators, and viceversa in the $\hat{\pi}$ representation, 
\begin{align}
    \hat{\phi}(x) &\to f(x)\, \cdot, \quad
    \hat{\pi}(x) \to -i \hbar \,\frac{\delta}{\delta f(x)}\,\quad \text{on $\hat{\phi}$ eigenstates }\, |f\rangle, \\
    \hat{\pi}(x) &\to g(x)\, \cdot, \quad
    \hat{\phi}(x) \to i \hbar \,\frac{\delta}{\delta g(x)}\,\quad \text{on $\hat{\pi}$ eigenstates } \,|g\rangle.
\end{align}
The same is true for the Fourier transformed $\hat{\phi}_k(t)$ and $\hat{\pi}_k(t)$, since they are just linear combinations of the $\hat{\phi}(x)$ and $\hat{\pi}(x)$ operators, with multplication and functional derivatives $f_k$ and $g_k$ respectively.
That is, for any functional $\Psi[f] = \langle f | \Psi \rangle$ of the field consifgurations $f$, respectively of $g$, we have
{\small 
\begin{align}
    \langle f | \hat{\phi}(x) | \Psi \rangle &= f(x) \Psi[f], \quad \langle f | \hat{\phi}_k | \Psi \rangle = f_k \Psi[f], \quad
    \langle f | \hat{\pi}(x) | \Psi \rangle = -i \hbar \frac{\delta}{\delta f(x)} \Psi[f], \quad 
    \langle f | \hat{\pi}_k | \Psi \rangle = -i \hbar \frac{\delta}{\delta f_k} \Psi[f],\\
    \langle g | \hat{\pi}(x) | \Psi \rangle &= g(x) \Psi[g], \quad \langle g | \hat{\pi}_k | \Psi \rangle = g_k \Psi[g], \quad
    \langle g | \hat{\phi}(x) | \Psi \rangle = i \hbar \frac{\delta}{\delta g(x)} \Psi[g],\quad \langle g | \hat{\phi}_k | \Psi \rangle = i \hbar \frac{\delta}{\delta g_k} \Psi[g].
\end{align}
}
%
In particular, the fields act like this on the \emph{wave functional} $\Psi$ of the system i.e. the one obeying the Schrödinger equation in QFT discussed above.
For example, if the system is in one of the field eigenstates $|f_0\rangle$, its wave functional is simply
\begin{align}
    \Psi[f] = \langle f | f_0 \rangle = \delta(f - f_0),
\end{align}
and the action of the operators is (again, analogous results hold for the $\hat{\pi}$ representation)
\begin{align}
    \langle f | \hat{\phi}(x) | f_0 \rangle &= f(x) \delta(f - f_0), \quad
    \langle f | \hat{\pi}(x) | f_0 \rangle = -i \hbar \frac{\delta}{\delta f(x)} \delta(f - f_0).
\end{align}
Implementing the $\hat{\phi}$ and $\hat{\pi}$ operators in any of the two ways indeed reproduces the canonical commutation relations (easy check) and thus provides two \emph{unitaryly equivalent} representations of the operator algebra on the Fock space $\mathcal{F}$.

%
In fact, we can represent \emph{any} operator $\hat{O}$ acting on the Fock space in either the $\hat{\phi}$ or $\hat{\pi}$ representation by inserting suitable resolutions of the identity
\begin{align}
    \hat{O}= \int_{W_{\phi}} \int_{W_{\phi}} Df\, Df' \, |f\rangle\, \langle f | \hat{O} | f' \rangle \langle f' |= \int_{W_{\pi}} \int_{W_{\pi}} Dg\, Dg' \, |g\rangle\, \langle g | \hat{O} | g' \rangle \, \langle g' |.
\end{align}
In particular, in the two representations, in position and momentum space respectively, the Hamiltonian reads\footnote{Recall that self-adjointness/reality implies $\hat{\phi}^\dagger_k=-\hat{\phi}_k$, $\hat{\pi}^\dagger_k=-\hat{\pi}_k$ and $f_k^* = f_{-k}$, $g_k^* = g_{-k}$, and each element commutes with its adjoint.}
\todotag{fix}
{\small
\begin{align}
    &\hat{H} = \int d^3 x\,\tfrac{1}{2}\left( \hat{\pi}^2 +  (\nabla \hat{\phi})^2 + m^2 \hat{\phi}^2 \right)
    = \int \frac{d^3k}{(2\pi)^3}\,\tfrac{1}{2}\left(\hat{\pi}_k \hat{\pi}_{-k} + (|\mathbf{k}|^2 + m^2) \hat{\phi}_k \hat{\phi}_{-k}\right)
    \\
    &\to \int d^3 x\, \tfrac{1}{2} \left( -\hbar^2 \frac{\delta^2}{\delta f(x)^2} + (\nabla_x f(x))^2 + m^2 f(x)^2 \right) 
    = \int\frac{d^3k}{(2\pi)^3}\, \tfrac{1}{2} \left( -\hbar^2 \frac{\delta^2}{\delta f_k \,\delta f_k^*} + (|\mathbf{k}|^2 + m^2) f_{-k} f_k \right)
    \quad \text{on $\hat{\phi}$ eigenstates }|f\rangle, \\
    &\to \int d^3 x\, \tfrac{1}{2} \left( g(x)^2 - \hbar^2 \Big(\nabla_x \frac{\delta}{\delta g(x)}\Big)^2 - m^2 \hbar^2 \frac{\delta^2}{\delta g(x)^2} \right)
    = \int \frac{d^3k}{(2\pi)^3}\,\tfrac{1}{2} \left( g_{-k} g_{k} - \hbar^2 (|\mathbf{k}|^2 + m^2) \frac{\delta^2}{\delta g_k^* \,\delta g_k} \right)
    \quad \text{on $\hat{\pi}$ eigenstates }|g\rangle.
\end{align}
}
Crucially, had we used some infrared regularization considering the theory in a \emph{finite} volume, the Fourier modes\footnote{We would have modes $e^{\pm ikx}$ or $\sin(kx)$ for suitable $k=\2\pi(n_1/L_1,n_2/L_2,n_3/L_3)$ in a finite boxe with PBC or DBC resp. and modes $\propto R_n(r) Y_{\ell,m}(\theta,\phi)$ in a finite sphere etc} would be countabble discrete, integrals $d^3k$ would become (possibly infinite) sums and functional derivatives $\frac{\delta}{\delta f_k}$ would become ordinary derivatives $\frac{\partial}{\partial f_k}$, making the above expressions mathematically well-defined.
\end{mytheorem} 


\begin{mytheorem}[Solving the Schrödinger equations in the $\hat{\phi}$ representation\todotag{Fix \& finish}]
We can explicitly solve the Schrödinger equation in QFT for the free Klein-Gordon field in the $\hat{\phi}$ representation.
The Hamiltonian operator is reported above.
The time-dependent Schrödinger equation reads
\begin{align}
    i \hbar \frac{\partial}{\partial t} \Psi[t; f] &= \int \frac{d^3k}{(2\pi)^3}\, \tfrac{1}{2} \left( -\hbar^2 \frac{\delta^2}{\delta f_k \,\delta f_k^*} + (|\mathbf{k}|^2 + m^2) f_{-k} f_k \right) \Psi[t; f].
\end{align}
We can solve it by separation of variables, writing the wave functional as a product over Fourier modes
\begin{align}
    \Psi[t; f] = \prod_k \psi_k(t; f_k, f_k^*).
\end{align}
Plugging this into the Schrödinger equation, we obtain a separate equation for each Fourier mode
\begin{align}
    i \hbar \frac{\partial}{\partial t} \psi_k(t; f_k, f_k^*) &= \tfrac{1}{2} \left( -\hbar^2 \frac{\partial^2}{\partial f_k \,\partial f_k^*} + (|\mathbf{k}|^2 + m^2) f_{-k} f_k \right) \psi_k(t; f_k, f_k^*).
\end{align}
Each of these equations is formally identical to the Schrödinger equation of a single quantum harmonic oscillator with mass $m=1$ and frequency $\omega_k = \sqrt{|\mathbf{k}|^2 + m^2}$, with $f_k$ and $f_k^*$ playing the role of position and momentum variables.
The solutions are thus well-known energy eigenstates
\begin{align}
    \psi_{n_k}(t; f_k, f_k^*) &= \left( \frac{\omega_k}{\pi \hbar} \right)^{1/4} \frac{1}{\sqrt{2^{n_k} n_k!}} H_{n_k}\left( \sqrt{\frac{\omega_k}{\hbar}} f_{k} \right) e^{-\frac{\omega_k}{2\hbar} f_{k}^2} e^{-i E_{n_k} t/\hbar}, \quad
    E_{n_k} = \hbar \omega_k \left( n_k + \tfrac{1}{2} \right), \quad n_k = 0, 1, 2, \dots
\end{align}
The general solution of the Schrödinger equation is thus
\begin{align}
    \Psi[t; f] &= \prod_k \psi_{n_k}(t; f_k, f_k^* ) 
    = \prod_k \left( \frac{\omega_k}{\pi \hbar} \right)^{1/4} \frac{1}{\sqrt{2^{n_k} n_k!}} H_{n_k}\left( \sqrt{\frac{\omega_k}{\hbar}} f_{k} \right) e^{-\frac{\omega_k}{2\hbar} f_{k}^2} e^{-i E_{n_k} t/\hbar}.
\end{align}
This solution corresponds to the Fock space state
\begin{align}
    |\Psi\rangle = \bigotimes_k |n_k\rangle,
\end{align}
i.e. the state with $n_k$ particles in the mode $k$ for all $k$.
%
\end{mytheorem}


\begin{mytheorem}[Solving the Heisenberg equations in the $\hat{\phi}$ representation\todotag{Fix \& finish}]
%
Alternatively, we can solve the Heisenberg equations of motion for the free Klein-Gordon field in the $\hat{\phi}$ representation.
The Heisenberg equation for the field operator reads
\begin{align}
    \frac{\partial}{\partial t} \hat{\phi}(t, x) &= \frac{1}{i \hbar} [\hat{\phi}(t, x), \hat{H}] = \hat{\pi}(t, x), \\
    \frac{\partial}{\partial t} \hat{\pi}(t, x) &= \frac{1}{i \hbar} [\hat{\pi}(t, x), \hat{H}] = (\nabla^2 - m^2) \hat{\phi}(t, x).
\end{align}
Combining these two equations, we obtain the Klein-Gordon equation for the field operator
\begin{align}
    (\partial_t^2 - \nabla^2 + m^2) \hat{\phi}(t, x) = 0.
\end{align}
We can solve this equation by expanding the field operator in Fourier modes
\begin{align}
    \hat{\phi}(t, x) = \int \frac{d^3k}{(2\pi)^3} e^{i \mathbf{k} \cdot \mathbf{x}} \hat{\phi}_k(t).
\end{align}
Plugging this into the Klein-Gordon equation, we obtain a separate equation for each Fourier mode
\begin{align}
    \frac{d^2}{dt^2} \hat{\phi}_k(t) + \omega_k^2 \hat{\phi}_k(t) = 0, \quad \omega_k = \sqrt{|\mathbf{k}|^2 + m^2}.
\end{align}
Each of these equations is formally identical to the equation of motion of a single quantum harmonic oscillator with frequency $\omega_k$.
The solutions are thus well-known
\begin{align}
    \hat{\phi}_k(t) &= \hat{a}_k e^{-i \omega_k t} + \hat{a}_k^\dagger e^{i \omega_k t}, \\
    \hat{\pi}_k(t) &= -i \hbar \omega_k \left( \hat{a}_k e^{-i \omega_k t} - \hat{a}_k^\dagger e^{i \omega_k t} \right).
\end{align}
The operators $\hat{a}_k$ and $\hat{a}_k^\dagger$ are the annihilation and creation operators for the mode $k$, satisfying the commutation relations
\begin{align}
    [\hat{a}_k, \hat{a}_{k'}^\dagger] = (2\pi)^3 \delta^{(3)}(k - k'), \quad [\hat{a}_k, \hat{a}_{k'}] = 0, \quad [\hat{a}_k^\dagger, \hat{a}_{k'}^\dagger] = 0.
\end{align}
%
    
\end{mytheorem}


